<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>대동고등학교 자습실 기기 이용 현황 (MVP)</title>
  <!-- TailwindCSS (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel (for JSX in the browser) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="app"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // ─────────────────────────────────────────────────────────
    // 로컬 저장 유틸
    // ─────────────────────────────────────────────────────────
    const STORAGE_KEY = "studyroom_devices_v1";
    const uid = () => `${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;

    const loadFromLocal = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : [];
      } catch (e) {
        console.error(e); return [];
      }
    };
    const saveToLocal = (devices) => localStorage.setItem(STORAGE_KEY, JSON.stringify(devices));

    // 시간 포맷 헬퍼
    const formatDuration = (ms) => {
      if (!ms || ms <= 0) return '-';
      const s = Math.floor(ms / 1000);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      if (h > 0) return `${h}시간 ${m}분`;
      if (m > 0) return `${m}분 ${sec}초`;
      return `${sec}초`;
    };

    function Dashboard(){
      const [devices, setDevices] = useState([]);
      const [query, setQuery] = useState("");
      const [sortKey, setSortKey] = useState("comfort"); // comfort | name | room
      const [showForm, setShowForm] = useState(false);
      const [editTarget, setEditTarget] = useState(null);
      const [now, setNow] = useState(Date.now());

      useEffect(() => { setDevices(loadFromLocal()); }, []);
      useEffect(() => { saveToLocal(devices); }, [devices]);
      // 30초마다 재렌더(가동 시간 갱신)
      useEffect(() => { const t = setInterval(()=>setNow(Date.now()), 30000); return ()=>clearInterval(t); }, []);

      const filtered = useMemo(() => {
        const q = query.trim().toLowerCase();
        const comfortScore = (d) => {
          const t = typeof d.tempCur === 'number' ? d.tempCur : 99;
          // 온도만 기준 (낮을수록 쾌적)
          return t <= 24 ? 0 : t <= 26 ? 1 : 2;
        };

        let list = devices.filter(d => {
          if (!q) return true;
          const hay = `${d.name} ${d.room} ${d.mode ?? ''}`.toLowerCase();
          return hay.includes(q);
        });

        if (sortKey === 'comfort') list.sort((a,b)=>comfortScore(a)-comfortScore(b));
        else if (sortKey === 'name') list.sort((a,b)=>a.name.localeCompare(b.name));
        else if (sortKey === 'room') list.sort((a,b)=>a.room.localeCompare(b.room));

        return list;
      }, [devices, query, sortKey]);

      const upsertDevice = (d) => {
        setDevices(prev => {
          const i = prev.findIndex(x=>x.id===d.id);
          if (i>=0){ const next=[...prev]; next[i]=d; return next; }
          return [d, ...prev];
        });
      };
      const removeDevice = (id) => setDevices(prev => prev.filter(d=>d.id!==id));

      const seedSamples = () => {
        const nowISO = new Date().toISOString();
        setDevices([
          { id: uid(), type: 'ac', name: '삼성 AC 1호', room: '본관 2층 자습실 A', power: true, mode: '냉방', tempSet: 24, tempCur: 23.5, updatedAt: nowISO },
          { id: uid(), type: 'ac', name: 'LG AC 2호', room: '과학동 3층 자습실 B', power: true, mode: '제습', tempSet: 25, tempCur: 26.1, updatedAt: nowISO },
          { id: uid(), type: 'purifier', name: '청정기 C', room: '본관 1층 열람실', power: true, powerOnAt: new Date(Date.now()-45*60*1000).toISOString(), updatedAt: nowISO },
          { id: uid(), type: 'purifier', name: '청정기 D', room: '별관 4층 스터디룸', power: false, powerOnAt: undefined, updatedAt: nowISO },
        ]);
      };

      const exportJSON = () => {
        const blob = new Blob([JSON.stringify(devices, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `devices_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
        a.click(); URL.revokeObjectURL(url);
      };
      const importJSON = (file) => {
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const data = JSON.parse(String(reader.result));
            if (!Array.isArray(data)) throw new Error('배열 형식 JSON이 아님');
            const norm = data.map(d => ({
              id: d.id || uid(), type: d.type || 'other', name: d.name || '무명 기기', room: d.room || '미지정',
              power: Boolean(d.power), mode: d.mode ?? undefined,
              tempSet: isFinite(d.tempSet) ? Number(d.tempSet) : undefined,
              tempCur: isFinite(d.tempCur) ? Number(d.tempCur) : undefined,
              powerOnAt: d.powerOnAt || undefined,
              updatedAt: d.updatedAt || new Date().toISOString(),
            }));
            setDevices(norm);
          }catch(e){ alert('JSON 읽기 오류: '+ e.message); }
        };
        reader.readAsText(file);
      };
// SmartThings에서 에어컨/공기청정기 후보를 가져와
// 대시보드에 없는 것만 자동 추가
const syncFromST = async () => {
  try {
    // 1) 토큰 가져오기 (처음 한 번만 입력 요청)
    let pat = localStorage.getItem('st_pat') || '';
    if (!pat) {
      pat = prompt('SmartThings 개인 액세스 토큰(PAT)을 입력하세요:')?.trim();
      if (!pat) return;
      localStorage.setItem('st_pat', pat);
    }

    // 2) SmartThings 기기 목록 조회
    const res = await fetch('https://api.smartthings.com/v1/devices', {
      headers: { Authorization: `Bearer ${pat}` }
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(`SmartThings API 오류: ${res.status} ${t}`);
    }
    const { items = [] } = await res.json();

    // 3) 에어컨/공기질 관련 capability 가진 기기만 추리기
    const isTarget = d =>
      (d.components || []).some(c =>
        (c.capabilities || []).some(cap =>
          [
            'airConditioner',
            'airPurifier',
            'airQualitySensor',
            'thermostatCoolingSetpoint',
            'switch',
          ].includes(cap.id)
        )
      );

    const targets = items.filter(isTarget);

    // 4) 대시보드 형식으로 변환
    const toCard = d => ({
      id: uid(),
      name: d.label || d.name,
      room: d.roomId || '',
      source: 'smartthings',
      st: { deviceId: d.deviceId },

      // 초기 표시값(대시보드에서 수정/업데이트 가능)
      power: 'off',
      mode: 'cool',
      current_temperature: null,
      target_temperature: null,

      createdAt: Date.now(),
      updatedAt: Date.now(),
    });

    // 5) 기존에 있는 것 제외하고 추가
    setDevices(prev => {
      const exists = new Set(prev.map(x => x.st?.deviceId).filter(Boolean));
      const addList = targets
        .filter(d => !exists.has(d.deviceId))
        .map(toCard);

      if (addList.length > 0) {
        alert(`SmartThings에서 ${addList.length}개 기기를 추가했습니다.`);
        return [...prev, ...addList];
      } else {
        alert('추가할 새 기기가 없습니다.');
        return prev;
      }
    });
  } catch (e) {
    console.error(e);
    alert('동기화 실패: ' + e.message);
  }
};

// 지금 버튼은 window.syncFromST를 호출하므로 연결해 둠
window.syncFromST = syncFromST;

      return (
        <div className="min-h-screen">
          {/* 헤더 */}
          <header className="sticky top-0 z-10 backdrop-blur bg-white/70 border-b">
            <div className="max-w-6xl mx-auto px-4 py-3 flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-between">
              <h1 className="text-lg sm:text-xl font-semibold">대동고등학교 자습실 기기 이용 현황 (MVP)</h1>
              <div className="flex flex-wrap items-center gap-2">
                <button className="px-3 py-2 rounded-xl bg-black text-white" onClick={()=>{ setEditTarget(null); setShowForm(true); }}>+ 기기 추가</button>
                <button className="px-3 py-2 rounded-xl border" onClick={seedSamples}>샘플 넣기</button>
                <button className="px-3 py-2 rounded-xl border" onClick={exportJSON}>내보내기(JSON)</button>
                <label className="px-3 py-2 rounded-xl border cursor-pointer">
                  불러오기(JSON)
                  <input type="file" accept="application/json" className="hidden" onChange={e=>{ const f=e.target.files?.[0]; if(f) importJSON(f); }} />
                </label>
<button
  className="px-3 py-2 rounded-xl border"
  onClick={() => window.syncFromST && window.syncFromST()}
>
  동기화
</button>
              </div>
            </div>
            <div className="max-w-6xl mx-auto px-4 pb-3">
              <div className="flex flex-col sm:flex-row gap-2">
                <input className="flex-1 border rounded-xl px-3 py-2" placeholder="기기/교실/모드 검색" value={query} onChange={e=>setQuery(e.target.value)} />
                <select className="border rounded-xl px-3 py-2" value={sortKey} onChange={e=>setSortKey(e.target.value)}>
                  <option value="comfort">정렬: 쾌적도</option>
                  <option value="name">정렬: 이름</option>
                  <option value="room">정렬: 교실</option>
                </select>
              </div>
              <p className="text-xs text-gray-500 mt-2">※ 지금은 로컬 저장만 합니다. 방학 끝나면 API 붙이면 자동 갱신 가능!</p>
            </div>
          </header>

          {/* 카드 그리드 */}
          <main className="max-w-6xl mx-auto px-4 py-4">
            {filtered.length === 0 ? (
              <div className="text-center text-gray-500 py-20">
                아직 등록된 기기가 없어요. <button className="underline" onClick={() => { setEditTarget(null); setShowForm(true); }}>기기 추가</button> 또는 <button className="underline" onClick={seedSamples}>샘플 넣기</button>
              </div>
            ) : (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {filtered.map(d => (
                  <DeviceCard key={d.id} d={d} now={now} onEdit={()=>{ setEditTarget(d); setShowForm(true); }} onDelete={()=>removeDevice(d.id)} />
                ))}
              </div>
            )}
          </main>

          {showForm && (
            <DeviceForm
              initial={editTarget}
              onClose={()=> setShowForm(false)}
              onSubmit={(payload)=>{
                const nowISO = new Date().toISOString();
                let next = { ...payload, id: payload.id || uid(), updatedAt: nowISO };
                // 공기청정기: 전원 ON 이면 powerOnAt 자동 세팅, OFF면 제거
                if (next.type === 'purifier') {
                  // 대시보드 단계에서는 자동으로 시작시간을 채우지 않음
                  if (!next.power) next.powerOnAt = undefined;
                }
                upsertDevice(next);
                setShowForm(false);
              }}
            />
          )}
        </div>
      );
    }

    const badgeColorByType = (type) => type === 'ac' ? 'bg-blue-100 text-blue-700' : type === 'purifier' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-700';
    const comfortTone = (d) => {
      const t = typeof d.tempCur === 'number' ? d.tempCur : 99;
      const cool = t <= 24; const ok = t <= 26;
      const bg = cool ? 'bg-blue-50' : ok ? 'bg-amber-50' : 'bg-rose-50';
      return { bg, labelTemp: cool ? '시원함' : ok ? '보통' : '더움' };
    };

    function DeviceCard({ d, now, onEdit, onDelete}){
      const tone = comfortTone(d);
      const started = d.powerOnAt ? new Date(d.powerOnAt) : null;
      const uptimeMs = d.power && started ? (now - started.getTime()) : 0;
      return (
        <div className={`rounded-2xl shadow-sm border ${tone.bg} p-4`}>
          <div className="flex items-start justify-between gap-2">
            <div>
              <div className="font-semibold">
                {d.name} <span className="text-gray-500">({d.room})</span>
              </div>
              <div className="mt-1 flex flex-wrap items-center gap-2 text-xs">
                <span className={`px-2 py-0.5 rounded-full ${badgeColorByType(d.type)}`}>
                  {d.type === 'ac' ? '에어컨' : d.type === 'purifier' ? '공기청정기' : '기타'}
                </span>
                <span className={`px-2 py-0.5 rounded-full ${d.power ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}`}>{d.power ? '전원 ON' : '전원 OFF'}</span>
                {d.mode && <span className="px-2 py-0.5 rounded-full bg-purple-100 text-purple-700">모드 {d.mode}</span>}
                <span className="text-gray-500">업데이트 {new Date(d.updatedAt).toLocaleTimeString()}</span>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button className="text-sm px-4 py-1.5 rounded-lg border whitespace-nowrap min-w-[56px] text-center" onClick={onEdit}>수정</button>
              <button className="text-sm px-4 py-1.5 rounded-lg border bg-white whitespace-nowrap min-w-[56px] text-center" onClick={onDelete}>삭제</button>
            </div>
          </div>

          {/* 본문: 종류별 표시 */}
          {d.type === 'ac' ? (
            <div className="grid grid-cols-2 gap-3 mt-4 text-sm">
              <div className="rounded-xl bg-white/60 p-3 border">
                <div className="text-xs text-gray-500">현재 온도</div>
                <div className="text-lg">{d.tempCur ?? '-'}℃</div>
              </div>
              <div className="rounded-xl bg-white/60 p-3 border">
                <div className="text-xs text-gray-500">설정 온도</div>
                <div className="text-lg">{d.tempSet ?? '-'}℃</div>
              </div>
            </div>
          ) : (
            <div className="grid grid-cols-2 gap-3 mt-4 text-sm">
              <div className="rounded-xl bg-white/60 p-3 border">
                <div className="text-xs text-gray-500">가동 시작</div>
                <div className="text-lg">{started ? started.toLocaleTimeString() : '-'}</div>
              </div>
              <div className="rounded-xl bg-white/60 p-3 border">
                <div className="text-xs text-gray-500">가동 시간</div>
                <div className="text-lg">{d.power ? formatDuration(uptimeMs) : '-'}</div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function DeviceForm({ initial, onClose, onSubmit }){
      const [form, setForm] = useState(() => initial ?? ({
        id: '', type: 'ac', name: '', room: '', power: true, mode: '',
        tempSet: undefined, tempCur: undefined,
        powerOnAt: undefined,
        updatedAt: new Date().toISOString(),
      }));

      const handleChange = (k, v) => setForm(prev => ({ ...prev, [k]: v }));
      const submit = (e) => {
        e.preventDefault();
        if (!form.name.trim()) return alert('기기 이름을 입력해 주세요');
        if (!form.room.trim()) return alert('교실/자습실 이름을 입력해 주세요');
        let payload = { ...form, mode: form.mode || undefined };
        if (payload.type === 'purifier') {
          const wasOn = initial ? Boolean(initial.power) : null;
          if (!payload.power) {
            payload.powerOnAt = undefined; // OFF면 시작시간 제거
          } else {
            const turnedOnNow = (wasOn === false && payload.power === true);
            // OFF→ON으로 바꾼 경우에만 자동 기록. 그 외엔 사용자가 '지금으로'를 누를 때만 설정
            if (turnedOnNow && !payload.powerOnAt) {
              payload.powerOnAt = new Date().toISOString();
            }
          }
        }
        onSubmit(payload);
      };

      return (
        <div className="fixed inset-0 z-20 flex items-center justify-center bg-black/30 p-4" onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}>
          <form onSubmit={submit} className="w-full max-w-xl bg-white rounded-2xl p-5 shadow-xl">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold">{form.id ? '기기 수정' : '기기 추가'}</h2>
              <button type="button" className="text-gray-500" onClick={onClose}>닫기</button>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
              <div>
                <label className="text-sm text-gray-600">기기 종류</label>
                <select className="w-full border rounded-xl px-3 py-2" value={form.type} onChange={e=>handleChange('type', e.target.value)}>
                  <option value="ac">에어컨</option>
                  <option value="purifier">공기청정기</option>
                  <option value="other">기타</option>
                </select>
              </div>
              <div>
                <label className="text-sm text-gray-600">전원</label>
                <select className="w-full border rounded-xl px-3 py-2" value={String(form.power)} onChange={e=>handleChange('power', e.target.value==='true')}>
                  <option value="true">ON</option>
                  <option value="false">OFF</option>
                </select>
              </div>
              <div>
                <label className="text-sm text-gray-600">기기 이름</label>
                <input className="w-full border rounded-xl px-3 py-2" placeholder="예) 삼성 AC 1호" value={form.name} onChange={e=>handleChange('name', e.target.value)} />
              </div>
              <div>
                <label className="text-sm text-gray-600">교실/자습실</label>
                <input className="w-full border rounded-xl px-3 py-2" placeholder="예) 본관 2층 자습실 A" value={form.room} onChange={e=>handleChange('room', e.target.value)} />
              </div>
              <div>
                <label className="text-sm text-gray-600">모드(옵션)</label>
                <input className="w-full border rounded-xl px-3 py-2" placeholder="예) 냉방, 제습, 자동" value={form.mode ?? ''} onChange={e=>handleChange('mode', e.target.value)} />
              </div>

              {/* 에어컨 전용 */}
              <div style={{display: form.type === 'ac' ? 'block' : 'none'}}>
                <label className="text-sm text-gray-600">설정 온도(℃, 옵션)</label>
                <input type="number" step="0.1" className="w-full border rounded-xl px-3 py-2" value={form.tempSet ?? ''} onChange={e=>handleChange('tempSet', e.target.value===''?undefined:Number(e.target.value))} />
              </div>
              <div style={{display: form.type === 'ac' ? 'block' : 'none'}}>
                <label className="text-sm text-gray-600">현재 온도(℃, 옵션)</label>
                <input type="number" step="0.1" className="w-full border rounded-xl px-3 py-2" value={form.tempCur ?? ''} onChange={e=>handleChange('tempCur', e.target.value===''?undefined:Number(e.target.value))} />
              </div>

              {/* 공기청정기 전용 */}
              <div style={{display: form.type === 'purifier' ? 'block' : 'none'}}>
                <label className="text-sm text-gray-600">가동 시작</label>
                <input className="w-full border rounded-xl px-3 py-2" readOnly value={form.powerOnAt ? new Date(form.powerOnAt).toLocaleString() : ''} placeholder="전원이 켜지면 자동 기록" />
                <div className="mt-2 flex gap-2">
                  <button type="button" className="px-2 py-1 rounded-lg border text-sm whitespace-nowrap" onClick={()=>handleChange('powerOnAt', new Date().toISOString())}>지금으로</button>
                  <button type="button" className="px-2 py-1 rounded-lg border text-sm whitespace-nowrap" onClick={()=>handleChange('powerOnAt', undefined)}>지우기</button>
                </div>
              </div>
              <div style={{display: form.type === 'purifier' ? 'block' : 'none'}}>
                <label className="text-sm text-gray-600">가동 시간</label>
                <input className="w-full border rounded-xl px-3 py-2" readOnly value={form.power && form.powerOnAt ? formatDuration(Date.now() - new Date(form.powerOnAt).getTime()) : ''} placeholder="전원이 켜져있을 때만 표시" />
              </div>
            </div>

            <div className="mt-5 flex items-center justify-end gap-2">
              <button type="button" className="px-4 py-2 rounded-xl border" onClick={onClose}>취소</button>
              <button type="submit" className="px-4 py-2 rounded-xl bg-black text-white">저장</button>
            </div>
          </form>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(<Dashboard />);
  </script>
<!-- 오른쪽 아래 수동/자동 새로고침 -->
<div id="syncFab" style="position:fixed; right:16px; bottom:16px; z-index:9999; display:flex; gap:8px;">
  <button id="apiSync"
    style="padding:10px 14px; border-radius:12px; border:1px solid #ccc; background:#111; color:#fff;">
    새로고침
  </button>
  <button id="autoToggle"
    style="padding:10px 14px; border-radius:12px; border:1px solid #ddd; background:#fff; color:#111;">
    자동 OFF
  </button>
</div>
<div id="syncInfo" style="position:fixed; right:16px; bottom:64px; font-size:12px; color:#666;"></div>

<script>
  // 기본 API 주소: 저장된 값 있으면 그거, 없으면 현재 사이트(origin)
  const getApiBase = () => localStorage.getItem('api_base') || window.location.origin;

  async function syncFromApi() {
    try {
      const base = prompt('API 주소 확인/변경', getApiBase()) || getApiBase();
      localStorage.setItem('api_base', base);

      const r = await fetch(base + '/api/rooms', { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      localStorage.setItem('studyroom_devices_v1', JSON.stringify(data));

      document.getElementById('syncInfo').textContent =
        '업데이트 ' + new Date().toLocaleTimeString();
      location.reload(); // 새 데이터로 화면 갱신
    } catch (e) {
      alert('가져오기 실패: ' + e.message);
    }
  }

  // 자동 새로고침 (기본 60초)
  let autoTimer = null;
  function startAuto() {
    stopAuto();
    autoTimer = setInterval(async () => {
      try {
        const r = await fetch(getApiBase() + '/api/rooms', { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        localStorage.setItem('studyroom_devices_v1', JSON.stringify(data));
        document.getElementById('syncInfo').textContent =
          '자동 업데이트 ' + new Date().toLocaleTimeString();
        location.reload();
      } catch (e) {
        console.warn('자동 새로고침 실패:', e.message);
      }
    }, 60000); // 60,000ms = 60초
  }
  function stopAuto() { if (autoTimer) clearInterval(autoTimer); autoTimer = null; }

  // 버튼 동작
  document.getElementById('apiSync').onclick = syncFromApi;

  const autoBtn = document.getElementById('autoToggle');
  function renderAutoBtn() {
    const on = localStorage.getItem('auto_sync') === '1';
    autoBtn.textContent = '자동 새로고침 ' + (on ? 'ON' : 'OFF');
  }
  autoBtn.onclick = () => {
    const on = !(localStorage.getItem('auto_sync') === '1');
    localStorage.setItem('auto_sync', on ? '1' : '0');
    renderAutoBtn();
    on ? startAuto() : stopAuto();
  };

  // 초기 상태 세팅
  renderAutoBtn();
  if (localStorage.getItem('auto_sync') === '1') startAuto();
</script>
<!-- iOS 스타일 자동 동기화 스위치 (기존 코드 지울 필요 없음) -->
<style id="ios-switch-style">
  /* 기존 autoToggle 텍스트 버튼이 있다면 숨기기 */
  #autoToggle{ display:none !important; }

  .ios-switch{position:relative;display:inline-block;width:52px;height:28px;vertical-align:middle}
  .ios-switch input{opacity:0;width:0;height:0}
  .ios-switch .slider{
    position:absolute;inset:0;cursor:pointer;border-radius:9999px;
    background:#e5e7eb; transition:.2s; box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
  }
  .ios-switch .slider:before{
    content:""; position:absolute; left:2px; top:2px; width:24px; height:24px;
    background:#fff; border-radius:50%; box-shadow:0 1px 2px rgba(0,0,0,.2); transition:.2s;
  }
  .ios-switch input:checked + .slider{ background:#22c55e; }
  .ios-switch input:checked + .slider:before{ transform:translateX(24px); }
</style>

<script>
(function(){
  // ===== 도우미 =====
  const getApiBase = ()=> localStorage.getItem('api_base') || window.location.origin;

  // 기존 syncFromApi가 있으면 그걸 쓰고, 없으면 기본 구현 생성
  const syncFromApi = window.syncFromApi || (async function(){
    try{
      const saved = getApiBase();
      const base = prompt('API 주소 확인/변경', saved) || saved;
      localStorage.setItem('api_base', base);
      const r = await fetch(base + '/api/rooms', { cache:'no-store' });
      if(!r.ok) throw new Error('HTTP ' + r.status);
      const d = await r.json();
      localStorage.setItem('studyroom_devices_v1', JSON.stringify(d));
      alert('가져오기 성공! 화면을 새로고침합니다.');
      location.reload();
    }catch(e){
      alert('가져오기 실패: ' + e.message);
    }
  });

  // 자동 갱신 (기존 함수 있으면 사용)
  const startAuto = window.startAuto || function(){
    if (window._autoSyncTimer) clearInterval(window._autoSyncTimer);
    window._autoSyncTimer = setInterval(async ()=>{
      try{
        const r = await fetch(getApiBase() + '/api/rooms', { cache:'no-store' });
        if(!r.ok) throw new Error('HTTP ' + r.status);
        const d = await r.json();
        localStorage.setItem('studyroom_devices_v1', JSON.stringify(d));
        // 조용히 갱신하고 싶으면 아래 한 줄 주석 처리 가능
        location.reload();
      }catch(e){
        console.warn('자동 새로고침 실패:', e.message);
      }
    }, 60000); // 60초
  };
  const stopAuto = window.stopAuto || function(){
    if (window._autoSyncTimer) clearInterval(window._autoSyncTimer);
    window._autoSyncTimer = null;
  };

  // ===== UI 요소 보장: 컨테이너/버튼/스위치 만들기 =====
  // 컨테이너(#syncFab)가 없으면 만들기
  let fab = document.getElementById('syncFab');
  if(!fab){
    fab = document.createElement('div');
    fab.id = 'syncFab';
    fab.style.cssText = 'position:fixed;right:16px;bottom:16px;z-index:9999;display:flex;gap:10px;align-items:center;';
    document.body.appendChild(fab);
  }

  // 수동 새로고침 버튼(#apiSync) 없으면 생성, 있으면 클릭 핸들러 보장
  let manualBtn = document.getElementById('apiSync');
  if(!manualBtn){
    manualBtn = document.createElement('button');
    manualBtn.id = 'apiSync';
    manualBtn.textContent = '새로고침';
    manualBtn.style.cssText = 'padding:10px 14px;border-radius:12px;border:1px solid #ccc;background:#111;color:#fff;';
    fab.appendChild(manualBtn);
  }
  manualBtn.onclick = syncFromApi;

  // iOS 스위치 없으면 생성
  if(!document.getElementById('autoSwitch')){
    const label = document.createElement('label');
    label.className = 'ios-switch';
    label.title = '자동 동기화';
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.id = 'autoSwitch';
    const span = document.createElement('span');
    span.className = 'slider';
    label.appendChild(input);
    label.appendChild(span);
    fab.appendChild(label);

    const txt = document.createElement('span');
    txt.id = 'autoText';
    txt.textContent = '자동';
    txt.style.cssText = 'font-size:13px;color:#666';
    fab.appendChild(txt);

    // 초기 상태
    const on = localStorage.getItem('auto_sync') === '1';
    input.checked = on;
    on ? startAuto() : stopAuto();

    // 토글 동작
    input.addEventListener('change', ()=>{
      const nowOn = input.checked;
      localStorage.setItem('auto_sync', nowOn ? '1' : '0');
      nowOn ? startAuto() : stopAuto();
    });
  }
})();
</script>
<script>
(function(){
  // 컨테이너와 스위치가 이미 만들어져 있다는 전제(이전 코드 유지)
  const fab   = document.getElementById('syncFab');
  const swLbl = document.querySelector('label.ios-switch'); // 스위치 레이블
  if (!fab || !swLbl) return;

  // 기존 "자동" 텍스트가 있으면 제거
  const oldTxt = document.getElementById('autoText');
  if (oldTxt) oldTxt.remove();

  // 새로고침 버튼(#apiSync)와 스택의 아래끝이 맞도록 컨테이너 정렬 변경
  // (기존 center → flex-end)
  fab.style.alignItems = 'flex-end';

  // 텍스트(위) + 스위치(아래)를 담을 수직 스택 만들기
  const stack = document.createElement('div');
  stack.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:4px;';

  // 제목 텍스트
  const title = document.createElement('div');
  title.textContent = '자동 새로고침';
  title.style.cssText = 'font-size:12px;color:#666;line-height:1;';
  stack.appendChild(title);

  // 기존 스위치를 스택 아래에 붙이기 (이동)
  swLbl.parentNode.removeChild(swLbl);
  stack.appendChild(swLbl);

  // 스택을 컨테이너에 추가
  fab.appendChild(stack);
})();
</script>

</body>
<script>
  // 60초마다 /api/rooms 읽어와서 로컬 저장 -> 화면 갱신
  const API_BASE = localStorage.getItem('api_base') || 'http://localhost:3000';
  async function pullRooms() {
    try {
      const r = await fetch(API_BASE + '/api/rooms', { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const d = await r.json();
      localStorage.setItem('studyroom_devices_v1', JSON.stringify(d));
      location.reload(); // 심플하게 리로드
    } catch (e) {
      console.warn('자동 새로고침 실패:', e.message);
    }
  }
  setInterval(pullRooms, 60000); // 60,000ms = 60초
</script>

</html>
